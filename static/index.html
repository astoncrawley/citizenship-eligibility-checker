<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Citizenship Eligibility Checker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
      max-width: 800px;
    }
    input, select, button {
      margin: 0.5em 0;
      padding: 0.5em;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
    }
    .section {
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 8px;
    }
    #response {
      white-space: pre-wrap;
      background: #f6f6f6;
      padding: 1em;
      border-radius: 8px;
      margin-top: 1em;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>Citizenship Eligibility Checker</h1>

  <form id="eligibility-form">
    <div class="section">
      <h2>Applicant Details</h2>
      <label>Full Name:</label>
      <input type="text" id="name" name="name" required />

      <label>Date of Birth:</label>
      <input type="date" id="dob" name="dob" required />

      <!-- <label>Country of Birth:</label><br>
      <select id="birth_country"></select><br><br> -->

      <label>Country of Birth:</label>
      <select id="country_of_birth" name="country_of_birth" required>
        <option value="">Select Country</option>
        <option value="Germany">Germany</option>
        <option value="Ireland">Ireland</option>
        <option value="Netherlands">Netherlands</option>
        <option value="United Kingdom">United Kingdom</option>
        <option value="France">France</option>
        <option value="United States">United States</option>
      </select>

      <label>Gender:</label>
      <select id="gender" name="gender" required>
        <option value="">Select Gender</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="section" id="parents-section">
      <h2>Parents</h2>
      <button type="button" id="add-parent">Add Parent</button>
    </div>

    <div class="section">
      <h2>Citizenships</h2>
      <button type="button" id="add-citizenship">Add Citizenship</button>
      <div id="citizenships-container"></div>
    </div>

    <button type="submit">Check Eligibility</button>
    <button type="button" id="download-json">Download JSON</button>
  </form>

  <div id="response">Response will appear here...</div>

  <script>
    // // --- Country List (can later load from /data/countries.json) ---
    // const countries = [
    //   "Select Country", "United Kingdom", "Germany", "France", "Italy", "Spain", "Canada", "United States",
    //   "Australia", "India", "China", "Japan", "South Africa", "Brazil", "Ireland"
    // ];

    // function populateCountryDropdown(selectElement) {
    //   selectElement.innerHTML = "";
    //   countries.forEach(country => {
    //     const option = document.createElement("option");
    //     option.value = country;
    //     option.textContent = country;
    //     selectElement.appendChild(option);
    //   });
    // }

    const parentsSection = document.getElementById("parents-section");
    const citizenshipsContainer = document.getElementById("citizenships-container");
    // const responseBox = document.getElementById("response");

    // populateCountryDropdown(document.getElementById("birth_country"));

    // Add parent input group
    document.getElementById("add-parent").addEventListener("click", () => {
      const parentDiv = document.createElement("div");
      parentDiv.className = "section parent-block";
      parentDiv.innerHTML = `
        <h3>Parent</h3>
        <label>Full Name:</label>
        <input type="text" class="parent-name" required />

        <label>Date of Birth:</label>
        <input type="date" class="parent-dob" required />

        <label>Country of Birth:</label>
        <select class="parent-country" required>
          <option value="">Select Country</option>
          <option value="Germany">Germany</option>
          <option value="Ireland">Ireland</option>
          <option value="Netherlands">Netherlands</option>
          <option value="United Kingdom">United Kingdom</option>
          <option value="France">France</option>
          <option value="United States">United States</option>
        </select>

        <label>Gender:</label>
        <select class="parent-gender" required>
          <option value="">Select Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>

        <h4>Parent Citizenships</h4>
        <button type="button" class="add-parent-citizenship">Add Citizenship</button>
        <div class="parent-citizenships"></div>
      `;

      parentDiv.querySelector(".add-parent-citizenship").addEventListener("click", (e) => {
        const container = parentDiv.querySelector(".parent-citizenships");
        const div = document.createElement("div");
        div.innerHTML = `
          <label>Country:</label>
          <select class="parent-cit-country" required>
            <option value="">Select Country</option>
            <option value="Germany">Germany</option>
            <option value="Ireland">Ireland</option>
            <option value="Netherlands">Netherlands</option>
            <option value="United Kingdom">United Kingdom</option>
            <option value="France">France</option>
            <option value="United States">United States</option>
          </select>

          <label>Acquisition Method:</label>
          <select class="parent-cit-method" required>
            <option value="by_birth">By Birth</option>
            <option value="by_descent">By Descent</option>
            <option value="by_naturalization">By Naturalization</option>
            <option value="by_marriage">By Marriage</option>
          </select>

          <label>Acquisition Date:</label>
          <input type="date" class="parent-cit-date" required />
        `;
        container.appendChild(div);
      });

      parentsSection.appendChild(parentDiv);
    });

    // Add citizenship input group for the applicant
    document.getElementById("add-citizenship").addEventListener("click", () => {
      const div = document.createElement("div");
      div.innerHTML = `
        <label>Country:</label>
        <select class="cit-country" required>
          <option value="">Select Country</option>
          <option value="Germany">Germany</option>
          <option value="Ireland">Ireland</option>
          <option value="Netherlands">Netherlands</option>
          <option value="United Kingdom">United Kingdom</option>
          <option value="France">France</option>
          <option value="United States">United States</option>
        </select>

        <label>Acquisition Method:</label>
        <select class="cit-method" required>
          <option value="by_birth">By Birth</option>
          <option value="by_descent">By Descent</option>
          <option value="by_naturalization">By Naturalization</option>
          <option value="by_marriage">By Marriage</option>
        </select>

        <label>Acquisition Date:</label>
        <input type="date" class="cit-date" required />
      `;
      citizenshipsContainer.appendChild(div);
    });

    // Handle form submission
    document.getElementById("eligibility-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      console.log("Submitting form...");
      const responseBox = document.getElementById("response");
      responseBox.textContent = "Processing...";

      try {
        // Gather applicant data
        const data = {
          name: document.getElementById("name").value,
          date_of_birth: document.getElementById("dob").value,
          country_of_birth: document.getElementById("country_of_birth").value,
          gender: document.getElementById("gender").value,
          parents: [],
          citizenships: []
        };

        // Collect parents
        const parentBlocks = document.querySelectorAll("#parents-section .parent-block");
        parentBlocks.forEach(parent => {
        const parentData = {
            name: parent.querySelector(".parent-name").value,
            date_of_birth: parent.querySelector(".parent-dob").value,
            country_of_birth: parent.querySelector(".parent-country").value,
            gender: parent.querySelector(".parent-gender").value,
            citizenships: []
        };

        parent.querySelectorAll(".parent-citizenships > div").forEach(citDiv => {
            parentData.citizenships.push({
            country: citDiv.querySelector(".parent-cit-country").value,
            method: citDiv.querySelector(".parent-cit-method").value,
            date: citDiv.querySelector(".parent-cit-date").value
            });
        });

        data.parents.push(parentData);
        });

        // Collect applicant citizenships
        citizenshipsContainer.querySelectorAll("div").forEach(div => {
          data.citizenships.push({
            country: div.querySelector(".cit-country").value,
            method: div.querySelector(".cit-method").value,
            date: div.querySelector(".cit-date").value
          });
        });

        // Send POST request
        console.log("Payload sent to backend:", data);
        const res = await fetch("http://localhost:8000/citizenship/evaluate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const resultText = await res.text();
        try {
          const result = JSON.parse(resultText);
          responseBox.textContent = JSON.stringify(result, null, 2);
        } catch {
          responseBox.textContent = "Non-JSON response: " + resultText;
        }

      } catch (error) {
        responseBox.textContent = "Fetch error: " + error;
      }
    });

    // Function to collect all data (shared between export and submit)
    function collectFormData() {
    const data = {
        name: document.getElementById("name").value,
        date_of_birth: document.getElementById("dob").value,
        country_of_birth: document.getElementById("country_of_birth").value,
        gender: document.getElementById("gender").value,
        parents: [],
        citizenships: []
    };

    // Collect parents
    const parentBlocks = document.querySelectorAll("#parents-section .parent-block");
    parentBlocks.forEach(parent => {
        const parentData = {
        name: parent.querySelector(".parent-name").value,
        date_of_birth: parent.querySelector(".parent-dob").value,
        country_of_birth: parent.querySelector(".parent-country").value,
        gender: parent.querySelector(".parent-gender").value,
        citizenships: []
        };

        parent.querySelectorAll(".parent-citizenships > div").forEach(citDiv => {
        parentData.citizenships.push({
            country: citDiv.querySelector(".parent-cit-country").value,
            method: citDiv.querySelector(".parent-cit-method").value,
            date: citDiv.querySelector(".parent-cit-date").value
        });
        });

        data.parents.push(parentData);
    });

    // Collect applicant citizenships
    const citizenshipsContainer = document.getElementById("citizenships-container");
    citizenshipsContainer.querySelectorAll("div").forEach(div => {
        data.citizenships.push({
        country: div.querySelector(".cit-country").value,
        method: div.querySelector(".cit-method").value,
        date: div.querySelector(".cit-date").value
        });
    });

    return data;
    }

    // Add export JSON button functionality
    document.getElementById("download-json").addEventListener("click", () => {
    const data = collectFormData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "citizenship_data.json";
    a.click();
    URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>
